<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å§¿å‹¢åˆ¤å®šï¼ˆiOSå¯¾å¿œãƒ»é¦–è§’åº¦æ¨å®šï¼‰</title>

<style>
  :root { --w: 240px; --h: 320px; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP";
    font-size: 16px;
    margin: 0;
    background: #fafafa;
    color: #111;
  }
  header {
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #eee;
    position: sticky;
    top: 0;
  }
  h1 { font-size: 18px; margin: 0; }

  main {
    padding: 12px;
    display: grid;
    gap: 12px;
    place-items: center;
  }

  .pair {
    display: flex;
    gap: 8px;
    justify-content: center;
  }
  video, canvas {
    width: var(--w);
    height: var(--h);
    background: #000;
    border-radius: 8px;
    border: 1px solid #ddd;
    transform: scaleX(-1);
  }

  .controls {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  button {
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background: #fff;
    font-size: 14px;
  }
  button.primary {
    background: #0ea5e9;
    color: #fff;
    border-color: #0ea5e9;
  }

  .panel {
    width: min(680px, 92vw);
    background: #fff;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 12px;
  }

  .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }

  #warning {
    font-size: 22px;
    font-weight: 800;
    text-align: center;
  }
  .ok { color: #16a34a; }
  .bad { color: #dc2626; }
</style>
</head>

<body>

<header>
  <h1>ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å§¿å‹¢åˆ¤å®šï¼ˆé¦–è§’åº¦æ¨å®šï¼‰</h1>
</header>

<main>

  <div class="pair">
    <!-- â˜… iOSå¯¾ç­–ï¼šmuted å¿…é ˆ -->
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <button id="startBtn" class="primary">é–‹å§‹</button>
    <button id="calibBtn" disabled>ã‚­ãƒ£ãƒªãƒ–</button>
  </div>

  <div class="panel">
    <div id="warning">å¾…æ©Ÿä¸­</div>
    <hr>

    <div class="mono">
      é¡”è§’åº¦ Î¸ï¼ˆä¸‹å‘ãï¼‹ï¼‰: <span id="faceDeg">--</span>Â°<br>
      ã‚¹ãƒãƒ›è§’åº¦ Ï†: <span id="phoneDeg">--</span>Â°<br>
      <br>
      <strong>é¦–è§’åº¦ = Î¸ âˆ’ Ï†</strong><br>
      é¦–è§’åº¦: <span id="neckDeg">--</span>Â°
    </div>
  </div>

</main>

<!-- MediaPipe FaceMeshï¼ˆiOS Safariå®‰å®šç‰ˆï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= çŠ¶æ…‹ ================= */
let faceMesh, camera;
let phoneDeg = 0;
let rawFaceDeg = 0;
let smoothFaceDeg = 0;
let neckDeg = 0;

let baseFace = 0;
let basePhone = 0;
let calibrated = false;

const FACE_GAIN = 2.0;   // é¡”è§’åº¦æ„Ÿåº¦ï¼ˆ1.5ã€œ3.0ã§èª¿æ•´ï¼‰
const SMOOTH = 0.2;

/* ================= DOM ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const faceDegEl = document.getElementById("faceDeg");
const phoneDegEl = document.getElementById("phoneDeg");
const neckDegEl = document.getElementById("neckDeg");
const warningEl = document.getElementById("warning");

const startBtn = document.getElementById("startBtn");
const calibBtn = document.getElementById("calibBtn");

/* ================= ã‚¹ãƒãƒ›å‚¾ã ================= */
async function startOrientation() {
  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    const res = await DeviceOrientationEvent.requestPermission();
    if (res !== "granted") throw new Error("ã‚»ãƒ³ã‚µè¨±å¯ãŒå¿…è¦ã§ã™");
  }
  window.addEventListener("deviceorientation", e => {
    if (typeof e.beta === "number") {
      phoneDeg = Math.abs(e.beta);
      phoneDegEl.textContent = phoneDeg.toFixed(1);
    }
  });
}

/* ================= é¡”è§’åº¦ï¼ˆç¬¦å·ä¿®æ­£æ¸ˆã¿ï¼‰ ================= */
function calcFaceAngle(lm) {
  const nose = lm[1];
  const chin = lm[152];

  const dz = chin.z - nose.z;
  const dy = chin.y - nose.y;

  // â˜… ä¸‹ã‚’å‘ãã»ã© + ã«ãªã‚‹ã‚ˆã†ç¬¦å·åè»¢
  let deg = -Math.atan2(dz, Math.abs(dy) + 1e-6) * 180 / Math.PI;

  deg *= FACE_GAIN;
  deg = Math.max(-60, Math.min(60, deg));

  rawFaceDeg = deg;
  smoothFaceDeg = smoothFaceDeg * (1 - SMOOTH) + deg * SMOOTH;

  faceDegEl.textContent = smoothFaceDeg.toFixed(1);
}

/* ================= é¦–è§’åº¦ ================= */
function updateNeck() {
  const dFace = smoothFaceDeg - baseFace;
  const dPhone = phoneDeg - basePhone;
  neckDeg = dFace - dPhone;

  neckDegEl.textContent = neckDeg.toFixed(1);

  if (!calibrated) {
    warningEl.textContent = "ã‚­ãƒ£ãƒªãƒ–ã—ã¦ãã ã•ã„";
    warningEl.className = "";
    return;
  }

  if (Math.abs(neckDeg) < 10) {
    warningEl.textContent = "âœ“ è‰¯ã„å§¿å‹¢";
    warningEl.className = "ok";
  } else if (Math.abs(neckDeg) < 25) {
    warningEl.textContent = "â–³ æ³¨æ„";
    warningEl.className = "";
  } else {
    warningEl.textContent = "âœ— å§¿å‹¢ãŒæ‚ªã„";
    warningEl.className = "bad";
  }
}

/* ================= FaceMesh ================= */
async function init() {
  await startOrientation();

  faceMesh = new FaceMesh({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  faceMesh.onResults(res => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(res.image, 0,0,canvas.width,canvas.height);

    if (res.multiFaceLandmarks?.length) {
      calcFaceAngle(res.multiFaceLandmarks[0]);
      updateNeck();
    }
  });

  camera = new Camera(video, {
    onFrame: async () => await faceMesh.send({ image: video }),
    width: 640,
    height: 480
  });

  await camera.start();

  startBtn.disabled = true;
  calibBtn.disabled = false;
}

/* ================= ã‚­ãƒ£ãƒªãƒ– ================= */
function calibrate() {
  baseFace = smoothFaceDeg;
  basePhone = phoneDeg;
  calibrated = true;
}

/* ================= UI ================= */
startBtn.onclick = () => init().catch(e => alert(e.message));
calibBtn.onclick = calibrate;
</script>

</body>
</html>
