<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å§¿å‹¢åˆ¤å®šï¼ˆå€‹äººå·®å¯¾å¿œç‰ˆï¼‰</title>
  <style>
    :root { --w: 240px; --h: 320px; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP",
        "Apple Color Emoji", "Segoe UI Emoji";
      font-size: 18px; margin: 0; color: #111; background: #fafafa;
    }
    header { padding: 12px 16px; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
    h1 { font-size: 20px; margin: 0; }
    main { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 12px; place-items: center; }
    .stage { display: flex; flex-direction: column; gap: 8px; align-items: center; }
    .pair { display: flex; gap: 8px; align-items: center; justify-content: center; flex-direction: row; }
    video, canvas {
      transform: scaleX(-1);
      width: var(--w); height: var(--h);
      border: 1px solid #ddd; background: #000; border-radius: 6px;
    }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    button {
      font-size: 15px; padding: 8px 14px; border-radius: 10px;
      border: 1px solid #ccc; background: #fff; cursor: pointer;
    }
    button.primary { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .panel { width: min(680px, 92vw); background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-line; }
    #warning { font-size: 24px; font-weight: 800; text-align: center; margin: 4px 0 0; }
    .ok { color: #16a34a; }
    .bad { color: #dc2626; }
    .hint { color: #666; font-size: 13px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; }
    @media (max-width: 760px) { .pair { flex-direction: column; flex-wrap: nowrap; } }

    #canvas { display: none; }
    .pair.hidden { display: none; }

    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      color: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      max-width: 90vw;
      text-align: center;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: #16a34a; }
    .toast.error { background: #dc2626; }
    .toast.info { background: #0ea5e9; }

    .sensitivity-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 14px;
      margin-top: 12px;
    }
    .sensitivity-section h3 { margin: 0 0 10px; font-size: 16px; color: #334155; }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .slider-row label { flex: 0 0 140px; font-size: 14px; color: #475569; }
    .slider-row input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #cbd5e1;
      outline: none;
      -webkit-appearance: none;
    }
    .slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #0ea5e9;
      cursor: pointer;
    }
    .slider-row input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #0ea5e9;
      cursor: pointer;
      border: none;
    }
    .slider-value {
      flex: 0 0 50px;
      text-align: right;
      font-family: ui-monospace, monospace;
      font-size: 14px;
      font-weight: 600;
      color: #0ea5e9;
    }
    .preset-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
    .preset-row button { font-size: 13px; padding: 6px 12px; }

    input[type="url"] {
      width: min(400px, 90vw);
      padding: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .yt-controls {
      margin-top: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    iframe {
      width: 100%;
      max-width: 640px;
      aspect-ratio: 16/9;
      border: none;
      border-radius: 8px;
      background: #000;
    }
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>

  <header>
    <h1>ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å§¿å‹¢åˆ¤å®šï¼ˆå€‹äººå·®å¯¾å¿œç‰ˆï¼‰</h1>
  </header>

  <main>
    <div class="stage">
      <div class="pair" id="cameraPair">
        <video id="video" playsinline autoplay></video>
        <canvas id="canvas"></canvas>
      </div>
      <div class="controls">
        <button id="startBtn" class="primary">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
        <button id="calibrateBtn" disabled>ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
        <button id="togglePreviewBtn" disabled>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º</button>
        <button id="testSensorBtn">ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ</button>
      </div>
    </div>

    <div class="panel">
      <h2 style="margin-top:0; font-size:18px;">ğŸ“Š å§¿å‹¢åˆ¤å®šçµæœ</h2>
      <div id="warning" class="bad">å¾…æ©Ÿä¸­...</div>

      <div style="margin-top: 16px;">
        <div class="row">
          <div>
            <div class="hint">é¦–ã®æ›²ãŒã‚Šé‡ï¼ˆåŸºæº–ã‹ã‚‰ã®å·®åˆ†ï¼‰</div>
            <div class="mono" style="font-size:24px; font-weight:700;" id="neckTilt">--Â°</div>
          </div>
          <div>
            <div class="hint">åˆ¤å®š</div>
            <div class="mono" style="font-size:20px; font-weight:600;" id="posture">--</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
        <h3 style="margin:0 0 8px; font-size:15px; color:#666;">ğŸ“ è¨ˆç®—è©³ç´°</h3>
        <div class="mono" style="font-size:13px; color:#555; line-height:1.6;">
          <div><span class="badge">Ï† (ã‚¹ãƒãƒ›ã®å‚¾ã)</span> <span id="phoneTilt">--Â°</span></div>
          <div><span class="badge">Î¸ (é¡”ã®å‘ã)</span> <span id="faceTilt">--Â°</span></div>

          <div style="margin-top:8px; padding:8px; background:#f1f5f9; border-radius:6px;">
            <strong>Î” = {(90-Ï†)+Î¸} - {(90-Ï†0)+Î¸0}</strong><br>
            <span id="calculation">= --</span>
          </div>

          <div style="margin-top:8px; padding:4px 8px; background:#fef3c7; border-radius:4px; font-size:11px;">
            <div>ãƒ‡ãƒãƒƒã‚°: beta=<span id="debugBeta">--</span> gamma=<span id="debugGamma">--</span></div>
            <div>åŸºæº–: Ï†0=<span id="debugPhi0">--</span> Î¸0=<span id="debugTheta0">--</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="sensitivity-section">
        <h3>âš™ï¸ æ„Ÿåº¦èª¿æ•´</h3>
        <div class="slider-row">
          <label>è‰¯ã„å§¿å‹¢ã®é–¾å€¤:</label>
          <input type="range" id="goodThreshold" min="0" max="45" value="20" step="1">
          <span class="slider-value"><span id="goodThresholdVal">20</span>Â°</span>
        </div>
        <div class="slider-row">
          <label>æ‚ªã„å§¿å‹¢ã®é–¾å€¤:</label>
          <input type="range" id="badThreshold" min="20" max="90" value="45" step="1">
          <span class="slider-value"><span id="badThresholdVal">45</span>Â°</span>
        </div>
        <div class="preset-row">
          <button onclick="applyPreset('strict')">å³ã—ã‚</button>
          <button onclick="applyPreset('normal')">æ¨™æº–</button>
          <button onclick="applyPreset('loose')">ã‚†ã‚‹ã‚</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2 style="margin-top:0; font-size:18px;">ğŸ“º YouTubeé€£å‹•ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
      <div>
        <input type="url" id="ytUrl" placeholder="YouTube URLã‚’å…¥åŠ›..." />
      </div>
      <div class="yt-controls">
        <button onclick="loadYouTube()">èª­è¾¼</button>
        <button onclick="playYouTube()">å†ç”Ÿ</button>
        <button onclick="pauseYouTube()">ä¸€æ™‚åœæ­¢</button>
      </div>
      <div id="ytContainer" style="display:none; margin-top:12px;">
        <iframe id="ytPlayer" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    let faceMesh;
    let camera;
    let ytPlayer = null;

    // ã‚­ãƒ£ãƒªãƒ–æ¸ˆã¿ã‹
    let isCalibrated = false;

    // åŸºæº–ï¼ˆã‚­ãƒ£ãƒªãƒ–æ™‚ã«ä¿å­˜ï¼‰
    let baselineFaceTilt = 0;   // Î¸0ï¼ˆç”Ÿå€¤rawï¼‰
    let baselinePhoneTilt = 0;  // Ï†0ï¼ˆã‚¹ãƒãƒ›è§’åº¦ï¼‰

    // é¡”æ¤œå‡ºçŠ¶æ…‹
    let lastFaceDetected = false;

    // ç¾åœ¨å€¤
    let phoneTiltAngle = 0;     // Ï†
    let rawFaceTiltAngle = 0;   // Î¸(ç”Ÿ)
    let faceTiltAngle = 0;      // Î¸ = raw - Î¸0
    let neckTiltAngle = 0;      // Î”ï¼ˆåŸºæº–å·®åˆ†ï¼‰

    // é–¾å€¤
    let goodThreshold = 20;
    let badThreshold = 45;

    // UI
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const calibrateBtn = document.getElementById('calibrateBtn');
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    const warning = document.getElementById('warning');

    let sensorStarted = false;

    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function getIsPortrait() {
      const type = window.screen.orientation?.type;
      if (type) return type.includes('portrait');
      if (window.matchMedia) return window.matchMedia("(orientation: portrait)").matches;
      return window.innerHeight >= window.innerWidth;
    }

    function startOrientationTracking() {
      if (sensorStarted) return Promise.resolve();

      return new Promise((resolve, reject) => {
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(state => {
              if (state === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation, true);
                sensorStarted = true;
                resolve();
              } else {
                showToast('âš  ãƒ‡ãƒã‚¤ã‚¹ã®å‚¾ãæ¤œå‡ºã®è¨±å¯ãŒå¿…è¦ã§ã™', 'error');
                reject(new Error('è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ'));
              }
            })
            .catch(err => {
              showToast('âœ— ãƒ‡ãƒã‚¤ã‚¹ã®å‚¾ãæ¤œå‡ºã®è¨±å¯ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              reject(err);
            });
        } else {
          window.addEventListener('deviceorientation', handleOrientation, true);
          sensorStarted = true;
          resolve();
        }
      });
    }

    function handleOrientation(event) {
      const beta = event.beta;
      const gamma = event.gamma;

      document.getElementById('debugBeta').textContent = beta !== null ? beta.toFixed(1) + 'Â°' : 'null';
      document.getElementById('debugGamma').textContent = gamma !== null ? gamma.toFixed(1) + 'Â°' : 'null';

      if (beta === null || gamma === null) {
        document.getElementById('phoneTilt').textContent = 'ã‚»ãƒ³ã‚µãƒ¼æœªå¯¾å¿œ';
        return;
      }

      const isPortrait = getIsPortrait();

      let tilt;
      if (isPortrait) {
        if (beta >= 0 && beta <= 90) tilt = beta;
        else if (beta > 90 && beta <= 180) tilt = 180 - beta;
        else if (beta < 0 && beta >= -90) tilt = Math.abs(beta);
        else tilt = 180 + beta;
      } else {
        tilt = Math.abs(gamma);
      }

      phoneTiltAngle = tilt;
      document.getElementById('phoneTilt').textContent = phoneTiltAngle.toFixed(1) + 'Â°';
    }

    async function initFaceMesh() {
      try {
        await startOrientationTracking();

        faceMesh = new FaceMesh({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onFaceMeshResults);

        camera = new Camera(video, {
          onFrame: async () => { await faceMesh.send({ image: video }); },
          width: 640,
          height: 480
        });

        await camera.start();

        startBtn.disabled = true;
        calibrateBtn.disabled = false;
        togglePreviewBtn.disabled = false;

        warning.textContent = 'ã‚«ãƒ¡ãƒ©ã¨ã‚»ãƒ³ã‚µãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ';
        warning.className = '';
        warning.style.color = '#0ea5e9';
        showToast('âœ“ ã‚«ãƒ¡ãƒ©ã¨ã‚»ãƒ³ã‚µãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        showToast('âœ— åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error', 5000);
      }
    }

    function onFaceMeshResults(results) {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;

      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        lastFaceDetected = true;
        const landmarks = results.multiFaceLandmarks[0];

        drawFaceLandmarks(landmarks);
        calculateFaceTilt(landmarks); // Î¸ï¼ˆç¬¦å·åè»¢æ¸ˆã¿ï¼‰
        calculateNeckTilt();          // Î”ï¼ˆåŸºæº–å·®åˆ†ï¼‰
        updatePostureWarning();
      } else {
        lastFaceDetected = false;
        warning.textContent = 'é¡”ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“';
        warning.className = 'bad';
        warning.style.color = '';
        document.getElementById('posture').textContent = '--';
        document.getElementById('posture').style.color = '';
        document.getElementById('faceTilt').textContent = '--Â°';
      }

      document.getElementById('debugPhi0').textContent = isCalibrated ? baselinePhoneTilt.toFixed(1) + 'Â°' : '--';
      document.getElementById('debugTheta0').textContent = isCalibrated ? baselineFaceTilt.toFixed(1) + 'Â°' : '--';

      ctx.restore();
    }

    function drawFaceLandmarks(landmarks) {
      ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
      for (const lm of landmarks) {
        ctx.beginPath();
        ctx.arc(lm.x * canvas.width, lm.y * canvas.height, 2, 0, Math.PI * 2);
        ctx.fill();
      }
      const nose = landmarks[1];
      ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
      ctx.beginPath();
      ctx.arc(nose.x * canvas.width, nose.y * canvas.height, 5, 0, Math.PI * 2);
      ctx.fill();

      const forehead = landmarks[10];
      ctx.fillStyle = 'rgba(0, 0, 255, 0.8)';
      ctx.beginPath();
      ctx.arc(forehead.x * canvas.width, forehead.y * canvas.height, 5, 0, Math.PI * 2);
      ctx.fill();
    }

    function calculateFaceTilt(landmarks) {
      const nose = landmarks[1];
      const forehead = landmarks[10];

      // â˜…ç¬¦å·åè»¢ï¼šä¸‹ã‚’å‘ãã»ã© + ã«ãªã‚Šã‚„ã™ã„
      const deltaY = nose.y - forehead.y;

      const faceHeight = Math.abs(landmarks[152].y - landmarks[10].y) || 1e-6;
      const normalizedTilt = deltaY / faceHeight;

      let raw = normalizedTilt * 60;
      raw = Math.max(-45, Math.min(45, raw));

      rawFaceTiltAngle = raw;

      // è£œæ­£å¾Œ Î¸ = raw - Î¸0ï¼ˆã‚­ãƒ£ãƒªãƒ–å‰ã¯ Î¸0=0 ã®ã¾ã¾ï¼‰
      faceTiltAngle = rawFaceTiltAngle - baselineFaceTilt;

      document.getElementById('faceTilt').textContent = faceTiltAngle.toFixed(1) + 'Â°';
    }

    // â˜…ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰æ–¹å¼ï¼šÎ” = {(90-Ï†)+Î¸} - {(90-Ï†0)+Î¸0}
    function calculateNeckTilt() {
      const A = (90 - phoneTiltAngle) + rawFaceTiltAngle;
      const A0 = (90 - baselinePhoneTilt) + baselineFaceTilt;

      // åŸºæº–å·®åˆ†
      neckTiltAngle = A - A0;

      document.getElementById('neckTilt').textContent = neckTiltAngle.toFixed(1) + 'Â°';

      const detail =
        `= {(90-${phoneTiltAngle.toFixed(1)})+${rawFaceTiltAngle.toFixed(1)}}`
        + ` - {(90-${baselinePhoneTilt.toFixed(1)})+${baselineFaceTilt.toFixed(1)}}`
        + ` = ${neckTiltAngle.toFixed(1)}Â°`;
      document.getElementById('calculation').textContent = detail;
    }

    function updatePostureWarning() {
      warning.style.color = '';

      if (!isCalibrated) {
        warning.textContent = 'ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„';
        warning.className = '';
        warning.style.color = '#0ea5e9';
        document.getElementById('posture').textContent = 'æœªè¨­å®š';
        document.getElementById('posture').style.color = '#0ea5e9';
        return;
      }

      const absTilt = Math.abs(neckTiltAngle);

      if (absTilt < goodThreshold) {
        warning.textContent = 'âœ“ è‰¯ã„å§¿å‹¢ã§ã™ï¼';
        warning.className = 'ok';
        document.getElementById('posture').textContent = 'è‰¯å¥½';
        document.getElementById('posture').style.color = '#16a34a';
      } else if (absTilt < badThreshold) {
        warning.textContent = 'â–³ å°‘ã—å§¿å‹¢ãŒæ‚ªã„ã§ã™';
        warning.className = '';
        warning.style.color = '#f59e0b';
        document.getElementById('posture').textContent = 'æ³¨æ„';
        document.getElementById('posture').style.color = '#f59e0b';
      } else {
        warning.textContent = 'âœ— å§¿å‹¢ãŒæ‚ªã„ã§ã™ï¼';
        warning.className = 'bad';
        document.getElementById('posture').textContent = 'æ‚ªã„';
        document.getElementById('posture').style.color = '#dc2626';

        if (ytPlayer && typeof ytPlayer.pauseVideo === 'function') ytPlayer.pauseVideo();
      }
    }

    // â˜…ã‚­ãƒ£ãƒªãƒ–ï¼šã‚¹ãƒãƒ›è§’åº¦Ï†0ã¨é¡”è§’Î¸0ã‚’ä¸¡æ–¹ä¿å­˜
    function calibrate() {
      if (!lastFaceDetected) {
        showToast('âš  é¡”ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error', 3000);
        return;
      }

      baselinePhoneTilt = phoneTiltAngle;   // Ï†0
      baselineFaceTilt  = rawFaceTiltAngle; // Î¸0ï¼ˆç”Ÿå€¤ï¼‰

      isCalibrated = true;

      showToast(`âœ“ ã‚­ãƒ£ãƒªãƒ–å®Œäº†ï¼(Ï†0:${baselinePhoneTilt.toFixed(1)}Â°, Î¸0:${baselineFaceTilt.toFixed(1)}Â°)`, 'success', 4000);
    }

    startBtn.addEventListener('click', initFaceMesh);
    calibrateBtn.addEventListener('click', calibrate);

    togglePreviewBtn.addEventListener('click', () => {
      const cameraPair = document.getElementById('cameraPair');
      if (cameraPair.classList.contains('hidden')) {
        cameraPair.classList.remove('hidden');
        togglePreviewBtn.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º';
      } else {
        cameraPair.classList.add('hidden');
        togglePreviewBtn.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º';
      }
    });

    document.getElementById('testSensorBtn').addEventListener('click', async () => {
      try {
        await startOrientationTracking();
        showToast('âœ“ ã‚»ãƒ³ã‚µãƒ¼èµ·å‹•å®Œäº†ï¼ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'success', 4000);
      } catch (err) {
        showToast('âœ— ã‚»ãƒ³ã‚µãƒ¼ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error', 4000);
      }
    });

    function clampThresholds() {
      if (badThreshold <= goodThreshold) {
        badThreshold = Math.min(90, goodThreshold + 1);
        document.getElementById('badThreshold').value = badThreshold;
        document.getElementById('badThresholdVal').textContent = badThreshold;
      }
    }

    document.getElementById('goodThreshold').addEventListener('input', (e) => {
      goodThreshold = parseInt(e.target.value, 10);
      document.getElementById('goodThresholdVal').textContent = goodThreshold;
      clampThresholds();
    });

    document.getElementById('badThreshold').addEventListener('input', (e) => {
      badThreshold = parseInt(e.target.value, 10);
      document.getElementById('badThresholdVal').textContent = badThreshold;
      clampThresholds();
    });

    function applyPreset(preset) {
      switch (preset) {
        case 'strict': goodThreshold = 15; badThreshold = 30; break;
        case 'normal': goodThreshold = 20; badThreshold = 45; break;
        case 'loose':  goodThreshold = 30; badThreshold = 60; break;
      }
      document.getElementById('goodThreshold').value = goodThreshold;
      document.getElementById('goodThresholdVal').textContent = goodThreshold;
      document.getElementById('badThreshold').value = badThreshold;
      document.getElementById('badThresholdVal').textContent = badThreshold;
      clampThresholds();
    }
    window.applyPreset = applyPreset;

    function loadYouTube() {
      const url = document.getElementById('ytUrl').value;
      const videoId = extractYouTubeID(url);
      if (!videoId) { showToast('âš  æœ‰åŠ¹ãªYouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

      document.getElementById('ytContainer').style.display = 'block';

      if (ytPlayer) {
        ytPlayer.loadVideoById(videoId);
        showToast('âœ“ YouTubeå‹•ç”»ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      } else {
        ytPlayer = new YT.Player('ytPlayer', {
          videoId,
          playerVars: { autoplay: 0, controls: 1 },
          events: { onReady: () => showToast('âœ“ YouTubeå‹•ç”»ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success') }
        });
      }
    }
    function playYouTube() { if (ytPlayer?.playVideo) ytPlayer.playVideo(); }
    function pauseYouTube() { if (ytPlayer?.pauseVideo) ytPlayer.pauseVideo(); }

    function extractYouTubeID(url) {
      const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[7] && match[7].length === 11) ? match[7] : null;
    }

    window.loadYouTube = loadYouTube;
    window.playYouTube = playYouTube;
    window.pauseYouTube = pauseYouTube;
  </script>
</body>
</html>
